var M=Object.defineProperty;var P=(s,e,o)=>e in s?M(s,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):s[e]=o;var q=(s,e,o)=>P(s,typeof e!="symbol"?e+"":e,o);const C={longRunnerPenalty:.85,ptwBoost:1.25,sequelPenalty:.75,prequelBoost:1.2,mmrLambda:.35,negativeLabelThrottle:4,timeDecayDaysBoost:1.05};class k{constructor(e){q(this,"w");this.w=e?[...e]:Array(10).fill(0)}ensure(e){this.w.length<e&&this.w.push(...Array(e-this.w.length).fill(0))}predict(e){let o=0;for(let n=0;n<e.length;n++)o+=this.w[n]*e[n];return 1/(1+Math.exp(-o))}update(e,o,n=.05){const c=this.predict(e),w=o-c;for(let i=0;i<e.length;i++)this.w[i]+=n*w*e[i]}}function A(s,e,o,n){var v,h;const c=s.baselineScore??(s.popularity??0)/1e3,w=e.ptw.includes(s.id)?1:0,i=(s.episodes??0)>52?1:0;let d=0;if(s.relations&&s.relations.length&&s.relations.some(l=>{var r;return((r=l.type)==null?void 0:r.toLowerCase())==="sequel"})){const l=s.relations.filter(r=>{var p;return((p=r.type)==null?void 0:p.toLowerCase())==="prequel"}).map(r=>r.toId);l.length&&!l.every(r=>e.watched.includes(r))&&(d=1)}const a=e.scores[s.id]??0,f=(n==null?void 0:n.timeBoost)??1;return[1,c,w,i,d,a/100,f,(((v=s.tags)==null?void 0:v.length)??0)/10,(((h=s.studios)==null?void 0:h.length)??0)/5,(s.year??2e3)/2050]}function T(s){return{userId:s.userId,watched:s.watched??[],ptw:s.ptw??[],scores:s.scores??{},hidden:s.hidden??[]}}function V(s={}){return new D({...C,...s})}class D{constructor(e){q(this,"cfg");this.cfg=e}async recommend(e,o,n=12){var l,r,p,L,B,S;const c=window.shokai||{},w=Date.now(),i=Object.values(o.catalog);if(!i.length)return[];let d=[];try{(l=c.rec)!=null&&l.loadEvents&&(d=await c.rec.loadEvents(e.userId,400))}catch{d=[]}let a=new k;try{if((r=c.rec)!=null&&r.getModel){const t=await c.rec.getModel(e.userId);t&&Array.isArray(t.w)&&(a=new k(t.w))}}catch{}for(const t of d){const u=o.catalog[t.itemId];if(!u)continue;const y=A(u,e);switch(a.ensure(y.length),t.type){case"click":case"add_to_ptw":case"play_start":a.update(y,1,.05);break;case"hide":a.update(y,0,.05);break}}const f=[],v=new Set(d.filter(t=>t.type!=="impression").map(t=>t.itemId)),h={};for(const t of d)t.type==="impression"&&(h[t.itemId]=(h[t.itemId]??0)+1);for(const t of i){if(e.hidden.includes(t.id))continue;const u=A(t,e,o,{timeBoost:this.cfg.timeDecayDaysBoost});a.ensure(u.length);const y=a.predict(u);let g=(t.baselineScore??(t.popularity??0)/1e3)*(1+y);e.ptw.includes(t.id)&&(g*=this.cfg.ptwBoost),(t.episodes??0)>52&&!e.ptw.includes(t.id)&&(g*=this.cfg.longRunnerPenalty),(p=t.relations)!=null&&p.some(m=>{var I;return((I=m.type)==null?void 0:I.toLowerCase())==="sequel"})&&((L=t.relations)!=null&&L.filter(m=>{var I;return((I=m.type)==null?void 0:I.toLowerCase())==="prequel"}).some(m=>!e.watched.includes(m.toId)))&&(g*=this.cfg.sequelPenalty),(h[t.id]??0)>=this.cfg.negativeLabelThrottle&&!v.has(t.id)&&(g*=.5),f.push({id:t.id,score:g,why:[]})}f.sort((t,u)=>u.score-t.score);const b=f.slice(0,n);try{if((B=c.rec)!=null&&B.insertEvent)for(const t of b)await c.rec.insertEvent({ts:w,userId:e.userId,itemId:t.id,type:"impression",context:"netrecV2:auto"})}catch{}try{(S=c.rec)!=null&&S.setModel&&await c.rec.setModel(e.userId,{w:a.w})}catch{}return b}}export{D as AnimeNetRecV2,V as createAnimeNetRecV2,T as makeProfile};
